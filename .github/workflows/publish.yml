name: publish

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      force:
        description: "Force publish even if no changes are detected"
        required: false
        default: "false"

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          registry-url: 'https://registry.npmjs.org'  # ADD THIS LINE

      - name: Clone upstream
        run: |
          git clone --depth 1 --filter=blob:none --sparse https://github.com/google/material-design-icons.git /tmp/material-design-icons
          git -C /tmp/material-design-icons sparse-checkout init --no-cone
          git -C /tmp/material-design-icons sparse-checkout set \
            "symbols/web/*/materialsymbolsrounded/*_24px.svg" \
            "symbols/web/*/materialsymbolsoutlined/*_24px.svg" \
            "symbols/web/*/materialsymbolssharp/*_24px.svg"

      - name: Generate icons
        run: node scripts/generate-icons.js --repo /tmp/material-design-icons

      - name: Detect changes
        id: diff
        run: |
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          elif git status --porcelain | grep -q .; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Configure git
        if: steps.diff.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version
        if: steps.diff.outputs.changed == 'true'
        run: npm version patch --no-git-tag-version

      - name: OIDC debug
        if: steps.diff.outputs.changed == 'true'
        run: |
          echo "OIDC URL set: ${ACTIONS_ID_TOKEN_REQUEST_URL:+yes}"
          echo "OIDC token set: ${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+yes}"
          node - <<'NODE'
          const https = require("https");
          const url = `${process.env.ACTIONS_ID_TOKEN_REQUEST_URL}&audience=npm`;
          const req = https.get(
            url,
            { headers: { Authorization: `Bearer ${process.env.ACTIONS_ID_TOKEN_REQUEST_TOKEN}` } },
            (res) => {
              let data = "";
              res.on("data", (chunk) => (data += chunk));
              res.on("end", () => {
                if (res.statusCode !== 200) {
                  console.error("OIDC request failed:", res.statusCode, data);
                  process.exit(1);
                }
                const token = JSON.parse(data).value;
                const payload = JSON.parse(Buffer.from(token.split(".")[1], "base64").toString("utf8"));
                const fields = [
                  "aud",
                  "iss",
                  "sub",
                  "repository",
                  "repository_owner",
                  "workflow",
                  "job_workflow_ref",
                  "ref",
                  "sha",
                  "actor"
                ];
                for (const field of fields) {
                  if (payload[field]) {
                    console.log(`${field}: ${payload[field]}`);
                  }
                }
              });
            }
          );
          req.on("error", (err) => {
            console.error(err);
            process.exit(1);
          });
          NODE

      - name: Commit changes
        if: steps.diff.outputs.changed == 'true'
        run: |
          git add .
          git commit -m "Update icons"
          git push

      - name: Publish
        if: steps.diff.outputs.changed == 'true'
        run: npm publish --provenance --access public
